<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Member & History</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #00b900; --dark-card: #1a1a1a; --gold: #D4AF37; }
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; }
        
        /* ‡∏ö‡∏±‡∏ï‡∏£ VIP */
        .vip-card { 
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; 
            padding: 25px; border-radius: 20px; border: 1px solid var(--gold);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; margin-bottom: 20px;
        }
        .vip-label { color: var(--gold); font-size: 0.7rem; letter-spacing: 2px; font-weight: bold; }
        .vip-name { font-size: 1.5rem; margin: 10px 0; font-weight: 700; }
        .vip-detail { font-size: 0.9rem; opacity: 0.8; }
        #userImg { position: absolute; right: 20px; top: 20px; width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 1rem; color: #333; border-left: 4px solid var(--line-green); padding-left: 10px; }
        
        label { font-size: 0.8rem; color: #666; display: block; margin-top: 10px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; }
        
        .btn-submit { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 1rem; }
        
        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .history-box { max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .h-date { color: #999; font-size: 0.7rem; }
        .h-note { color: #555; margin-top: 3px; }

        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

<div id="loading" class="loading">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--line-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
</div>

<div class="container">
    <div class="vip-card">
        <div class="vip-label">VIP MEMBER</div>
        <div id="dispName" class="vip-name">‡∏£‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        <div id="dispCompany" class="vip-detail">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: -</div>
        <div id="dispPhone" class="vip-detail">‡πÇ‡∏ó‡∏£: -</div>
        <img id="userImg" src="https://via.placeholder.com/60">
    </div>

    <div class="section">
        <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="fullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        <label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
        <input type="text" id="company" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="phone" maxlength="10">
        <label>‡πÇ‡∏ô‡πâ‡∏ï / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <textarea id="userNote" rows="2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."></textarea>
        
        <button class="btn-submit" onclick="saveAllInOne()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>

    <div class="section">
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
        <div id="historyList" class="history-box">
            <div style="text-align:center; color:#ccc; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "2008820291-s6WNZ5xr"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWeQ72gXDYMsX_mowZ9CRtbnrQ0NtW--IWLtfOk7-Xzz-Zjx4jofS7Cs4ATy58ZR2oSQ/exec"; 

    async function main() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById("userImg").src = profile.pictureUrl;
            fetchHistory(profile.userId);
        }
    }

    async function fetchHistory(userId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            const data = await res.json();
            if (data.status === "found") {
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                document.getElementById("dispName").innerText = data.user.fullName;
                document.getElementById("dispCompany").innerText = "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: " + data.user.company;
                document.getElementById("dispPhone").innerText = "‡πÇ‡∏ó‡∏£: " + data.user.phone;
                
                // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                document.getElementById("fullName").value = data.user.fullName;
                document.getElementById("company").value = data.user.company;
                document.getElementById("phone").value = data.user.phone;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                renderHistory(data.history);
            }
        } catch (e) { console.log("No history yet"); }
    }

    function renderHistory(history) {
        const list = document.getElementById("historyList");
        if (history.length === 0) return;
        list.innerHTML = history.map(item => `
            <div class="history-item">
                <div class="h-date">${item.date} | ${item.topic}</div>
                <div class="h-note">‡πÇ‡∏ô‡πâ‡∏ï: ${item.note}</div>
            </div>
        `).join('');
    }

    async function saveAllInOne() {
        const name = document.getElementById("fullName").value;
        const comp = document.getElementById("company").value;
        const ph = document.getElementById("phone").value;
        const note = document.getElementById("userNote").value;

        if (!name || !ph) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");

        document.getElementById("loading").style.display = "flex";
        const profile = await liff.getProfile();

        const payload = {
            userId: profile.userId,
            lineName: profile.displayName,
            fullName: name,
            company: comp,
            phone: ph,
            topic: "‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
            note: note || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ô‡πâ‡∏ï"
        };

        try {
            // 1. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheets
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ LINE
            if (liff.isInClient()) {
                await liff.sendMessages([{
                    "type": "text",
                    "text": `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${name}\nüìù ‡πÇ‡∏ô‡πâ‡∏ï: ${note || '-'}`
                }]);
            }

            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            // 3. ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            fetchHistory(profile.userId);
            document.getElementById("userNote").value = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏ô‡πâ‡∏ï
        } catch (e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    main();
</script>

<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</body>
</html>
