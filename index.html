<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Member Card</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #00b900; --gold: #D4AF37; --dark: #2c3e50; }
        body { font-family: 'Kanit', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å */
        .container { width: 100%; max-width: 400px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .active { display: block; animation: fadeIn 0.5s; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
        .header { background: linear-gradient(135deg, var(--dark), #4b6584); color: white; padding: 30px 20px; text-align: center; }
        
        /* ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
        .member-card { 
            background: linear-gradient(135deg, #1a1a1a, #434343); color: white; 
            border-radius: 15px; padding: 20px; margin: 20px; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3);
        }
        .card-label { font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; }
        .card-name { font-size: 1.4rem; font-weight: bold; margin: 10px 0; }
        .card-detail { font-size: 0.9rem; opacity: 0.8; }

        /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
        .form-section { padding: 25px; }
        label { display: block; margin-top: 15px; font-size: 0.85rem; color: #666; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: 'Kanit'; }
        
        button { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; transition: 0.3s; font-family: 'Kanit';
            margin-top: 25px;
        }
        .btn-main { background: var(--primary); color: white; font-size: 1.1rem; }
        .btn-outline { background: white; color: #666; border: 1px solid #ddd; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="loading" class="loading"><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div></div>

<div class="container">
    <div id="formPage" class="card active">
        <div class="header">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VIP</div>
        <div class="form-section">
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á</label>
            <input type="text" id="fullName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
            <input type="text" id="company" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="phone" maxlength="10">
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡πÇ‡∏ô‡πâ‡∏ï</label>
            <textarea id="userNote" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á..."></textarea>
            
            <button class="btn-main" onclick="saveAndShow()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£</button>
        </div>
    </div>

    <div id="displayPage" class="card">
        <div class="header" style="background: var(--primary)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</div>
        
        <div class="member-card">
            <div class="card-label">VIP MEMBER</div>
            <div id="resName" class="card-name">-</div>
            <div id="resCompany" class="card-detail">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: -</div>
            <div id="resPhone" class="card-detail">‡πÇ‡∏ó‡∏£: -</div>
            <div style="margin-top:20px; text-align:right;">
                <img id="userImg" src="" style="width:50px; border-radius:50%; border:2px solid var(--gold)">
            </div>
        </div>

        <div style="padding: 0 25px 25px;">
            <div style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 20px;">
                * ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            </div>
            <button class="btn-main" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            <button class="btn-outline" onclick="showForm()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "2008820291-s6WNZ5xr"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmG9VJb4gbYUVJeL9bDIZR8_AMuOI_eeZKzpdtJ-otUFSxBevThyxKHjUyy1YZZ_cW4A/exec"; 

    async function main() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); } 
        else {
            const profile = await liff.getProfile();
            document.getElementById("userImg").src = profile.pictureUrl;
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏•‡∏¢
            checkExisting(profile.userId);
        }
    }

    async function checkExisting(userId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            const data = await res.json();
            if (data.status === "found") {
                showDisplay(data);
            }
        } catch (e) { }
    }

    async function saveAndShow() {
        const profile = await liff.getProfile();
        const payload = {
            userId: profile.userId,
            lineName: profile.displayName,
            fullName: document.getElementById("fullName").value,
            company: document.getElementById("company").value,
            phone: document.getElementById("phone").value,
            note: document.getElementById("userNote").value,
            topic: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"
        };

        if (!payload.fullName || !payload.phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        document.getElementById("loading").style.display = "flex";

        try {
            // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheets
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });

            // 2. ‡∏™‡πà‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (liff.isInClient()) {
                await liff.sendMessages([{
                    "type": "text",
                    "text": `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\nüë§ ‡∏Ñ‡∏∏‡∏ì: ${payload.fullName}\nüè¢ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${payload.company}\nüìù ‡πÇ‡∏ô‡πâ‡∏ï: ${payload.note || '-'}`
                }]);
            }

            // 3. ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏±‡∏ï‡∏£
            showDisplay(payload);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        document.getElementById("loading").style.display = "none";
    }

    function showDisplay(data) {
        document.getElementById("resName").innerText = data.fullName;
        document.getElementById("resCompany").innerText = "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: " + (data.company || "-");
        document.getElementById("resPhone").innerText = "‡πÇ‡∏ó‡∏£: " + (data.phone || "-");
        
        document.getElementById("formPage").classList.remove("active");
        document.getElementById("displayPage").classList.add("active");
    }

    function showForm() {
        document.getElementById("displayPage").classList.remove("active");
        document.getElementById("formPage").classList.add("active");
    }

    main();
</script>
</body>
</html>
